<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <pre>

        <script>
            class XRegExp {
                constructor(source, flag, root = 'root') {
                    this.table = new Map()
                    this.regexp = new RegExp(this.complileRegExp(source, root, 0).source, flag);
                }
                complileRegExp(source, name, start) {
                    if (source[name] instanceof RegExp)
                        return {
                            source: source[name].source,
                            length: 0
                        }
                    let length = 0

                    let regexp = source[name].replace(/<([^>]*?)>/g, (str, $1) => {
                        this.table.set(start + length, $1)

                        ++length

                        let r = this.complileRegExp(source, $1, start + length)

                        length += r.length
                        return "(" + r.source + ")"
                    })
                    return {
                        source: regexp,
                        length: length
                    }
                }

                exec(str) {
                    let r = this.regexp.exec(str)
                    for (let i = 1; i < r.length; i++) {
                        if (r[i] !== void 0) {
                            r[this.table.get(i - 1)] = r[i]
                        }
                    }
                    return r
                }
                get lastIndex() {
                    return this.regexp.lastIndex
                }
                set lastIndex(v) {
                    return this.regexp.lastIndex = v
                }

            }
            function scan(str) {
                let regexp = new XRegExp({
                    inputElement: "<whiteSpace>|<lineTerminator>|<comment>|<token>",
                    whiteSpace: / /,
                    lineTerminator: /\n/,
                    comment: /\/\/[^\n]*|\/\*(?:[^*]|\*[^\/])\*\//,
                    token: "<literal>|<keywords>|<identifier>|<punctuator>",
                    literal: "numberLiteral | stringLiteral | booleanLiteral | nullLiteral",
                    numberLiteral: /(?:[1-9][0-9]|0)(?:\.[0-9]*|\.[0-9]+)/,
                    stringLiteral: /\"(?:[^"\n]|\\[\s\S])*\"|\'(?:[^"\n]|\\[\s\S])*\'/,
                    booleanLiteral: /true|false/,
                    nullLiteralL: /null/,
                    keywords: /if|new|for|function|else|let|var|const/,
                    identifier: /[a-zA-Z_$][a-zA-Z0-9_$]*/,
                    punctuator: /\+|-|\*|\/|%|\+\+|\=\=|\=|--|\,|\?|\:|\{|\}|\(|\)|\<|\>|!|;|\./
                }, "g", "inputElement")

                while (regexp.lastIndex < str.length) {
                    let r = regexp.exec(str)
                    console.log(r)
                    document.write(r)
                    if (!r[0].length)
                        break;
                }
            }

            scan(`
                for (let i = 0; i < 3; i++) {
                    for (let j = 0; j < 3; j++) {
                        let cell = document.createElement('div');
                        cell.classList.add("cell");
                        cell.innerText = pattern[i * 3 + j] == 2 ? "❌" : pattern[i * 3 + j] == 3 ? "⭕" : "";
                        BroadcastChannel.appendChild(document.createElement("br"))
                    }
                }
            `)

        </script>
        
        </pre>
</body>

</html>